#!/usr/bin/python
#encoding=utf-8

import sys
import os
import socket
import MySQLdb
from threading import Thread
import re
import socket
from DDtrace import gettrace

socket.setdefaulttimeout(600)

def main():
    con=MySQLdb.connect(host='localhost',user='root',passwd='19941017')
    cur=con.cursor()
    con.select_db('practice')
    count1=cur.execute("select id,tid from Ttable")
    aslist=cur.fetchall()
    f=open("targetip.txt", "r")
    lines=f.readlines()
    count2=0
    for line in lines:
    	count2=count2+1
    count=count1*count2
    k=0
    m=0
    print m
    for i in range(0,count,1000):                
    	    threads=[]
            for j in range(1000):
            	pos=i+j
           	if pos>=count:
               	    break
                if k>=count2:
		   k=k-count2
		   m=m+1
                   print m
                targip=lines[k].split('\n')[0]
	    	sql="select asn,link from AStable where id='%s'"%(aslist[m][0])
	        cur.execute(sql)
   	        result=cur.fetchall()
          	p=gettrace(result[0][0],result[0][1],targip,aslist[m][1])
            	thread=Thread(target=p)
            	threads.append(thread)
		k=k+1
            length=len(threads)    
            for a in range(length):
            	threads[a].start()
       	    for a in range(length):
            	threads[a].join()        
if __name__=='__main__':
    main()
         
        

#!/usr/bin/python
#encoding=utf-8

import sys
import os
import socket
import MySQLdb
from threading import Thread
import re
import socket
from gettracetmp import gettrace

socket.setdefaulttimeout(600)

url=re.compile(r'^http://')

def main():
    con=MySQLdb.connect(host='localhost',user='root',passwd='19941017')
    cur1=con.cursor()
    con.select_db('practice')
    count1=cur1.execute("select asn,link from AStable where avail='y' ")
    aslist=cur1.fetchall()          #取得所有有效的asn和其对应的url

    tmpip=socket.getaddrinfo("www.baidu.com", None)
    tgtip=tmpip[0][4][0]                         #get the ip of the target
    for i in range(0,count1,10):                 #一次有10个as去traceroute一个target
    	threads=[]
        for j in range(10):
            pos=i+j
            if pos>=count1:
                break
            p=gettrace(aslist[i+j][0],aslist[i+j][1],tgtip)
            thread=Thread(target=p)
            threads.append(thread)
        length=len(threads)    
        for a in range(length):
	    print "\n","from as",aslist[i+a][1],"to","www.baidu.com","\n----------------------------"
            threads[a].start()
        for a in range(length):
            threads[a].join()
                
        
if __name__=='__main__':
    main()
         
        

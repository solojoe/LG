#!/usr/bin/python
#encoding=utf-8

import sys
import os
import socket
import MySQLdb
from threading import Thread
import re
import socket
from DDtrace import gettrace

socket.setdefaulttimeout(600)

url=re.compile(r'^http://')

def main():
    con=MySQLdb.connect(host='localhost',user='root',passwd='19941017')
    cur=con.cursor()
    con.select_db('practice')
    count1=cur.execute("select id,tid from Ttable")
    aslist=cur.fetchall()
    f=open("targetip.txt", "r")
    lines=f.readlines() 
    tgtip=lines[0].split('\n')[0]
    for i in range(0,count1,1):                
    	    threads=[]
            for j in range(1):
            	pos=i+j
           	if pos>=count1:
               	    break
	    	sql="select asn,link from AStable where id='%s'"%(aslist[i+j][0])
	        cur.execute(sql)
   	        result=cur.fetchall()
          	p=gettrace(result[0][0],result[0][1],tgtip,aslist[i+j][1])
            	thread=Thread(target=p)
            	threads.append(thread)
	   	print "\n----------from ",result[0][1],"--",aslist[i+j][1],"to","HIT[",tgtip,"]\n----------------------------"
            length=len(threads)    
            for a in range(length):
            	threads[a].start()
       	    for a in range(length):
            	threads[a].join()
                
        
if __name__=='__main__':
    main()
         
        

#!/usr/bin/python
#coding=utf-8

import socket 
import time
import re
import MySQLdb
from bs4  import BeautifulSoup
from urllib2 import *

socket.setdefaulttimeout(300)
url='https://www.planet-lab.org/db/pub/sites.php'

con=MySQLdb.connect(host='localhost',user='root',passwd='1994101717')
cur=con.cursor()
cur.execute("create database if not exists planetlab")
print "conncted to DB of planetlab!"
con.select_db('planetlab')
cur.execute("drop table if exists pltable")
cur.execute("create table if not exists pltable(id int,link varchar(100),lon varchar(10),lat varchar(10),avail char,latestTime varchar(50) )")

id=0
request=Request(url)
f=urlopen(request)
soup=BeautifulSoup(f)

lis=soup.findAll('a')
p=re.compile(r'(http://)|(www\.)')
p1=re.compile(r'^-?\d+\.?\d*$')
timeformat="%Y-%m-%d %X"

for itema in lis:
    id+=1
    if not itema:
        id-=1
        continue
    if not re.search(p,repr(itema['href'])):
        id-=1
        continue
    
    link=itema['href']
    ltime=time.strftime(timeformat,time.localtime())
    linkname=itema.string
    
    if re.search('SUNY Binghamton',linkname):
        continue
    
    if not itema.parent.nextSibling:
        id-=1
        continue
    if not itema.parent.nextSibling.nextSibling:
        id-=1
        continue
    
    lon=itema.parent.nextSibling.string
    if (not lon) or (not re.search(p1,lon) ):
        id-=1
        continue
    
    lat=itema.parent.nextSibling.nextSibling.string
    if ( not lat )or (not re.search(p1,lat) ):
        id-=1
        continue
    
    try:
        request=Request(link)
        print "connecting to",linkname,"\n"
        f=urlopen(request)
        f.close()
    except HTTPError,e:
        avail='n'
        print linkname,":","HTTPError!\n"
    except URLError, e:   
        avail='n'
        print linkname,":","URLError!\n"
    except Exception, e:
        avail='n'
        #print linkname,":","BaseExceptionError\n"
    else:
        avail='y'

    value=(id,link,lon,lat,avail,ltime)
    cur.execute("INSERT into pltable values(%s,%s,%s,%s,%s,%s)",value)
    cur.execute("commit")
    print "--------------------------------------------"
cur.close()

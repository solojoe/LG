#!/usr/bin/python
import socket 
import time
import re
import MySQLdb
from bs4  import BeautifulSoup
from urllib2 import *

socket.setdefaulttimeout(60)
url='http://traceroute.org'

con=MySQLdb.connect(host='localhost',user='root',passwd='19941017')
cur=con.cursor()
cur.execute("create database if not exists practice")
print "conncted to DB!"
con.select_db('practice')
cur.execute("drop table if exists AStable1")
cur.execute("create table if not exists AStable1(id int,asn int,info varchar(100),link varchar(100),avail char,latestTime varchar(50),remark varchar(100))")
 
id=0
request=Request(url)
f=urlopen(request)
soup=BeautifulSoup(f)
lis=soup.findAll('li')
p=re.compile(r'(\D+)\(\s*AS\s*(\d+).*\)')
timeformat="%Y-%m-%d %X"
     
for item in lis:
    id+=1
    atag=item.a
    if not atag:
        id-=1
        continue
    if not re.search(p,repr(item.contents)):
        id-=1
        continue
    str=atag.string
    info=re.search(p,str).group(1)
    asn=re.search(p,str).group(2)
    link=atag['href']
    ltime=time.strftime(timeformat,time.localtime())
    try:
        request=Request(link)
        print "connecting to",asn,"\n"
        f=urlopen(request)
        f.close()
    except HTTPError,e:
        avail='n'
        remark="HTTPError"
        #print e,"\n"
        print asn,":","HTTPError!\n"
    except URLError, e:   
        avail='n'
        remark="URLError"
        #print e,"\n"
        print asn,":","URLError!\n"
    except Exception, e:
        avail='n'
        remark="BaseExceptionError"
        print asn,":","BaseExceptionError\n"
    else:
        avail='y'
        remark='ok'
    
    value=(id,asn,info,link,avail,ltime,remark)
    cur.execute("INSERT into AStable1 values(%s,%s,%s,%s,%s,%s,%s)",value)
    cur.execute("commit")
    print asn,"has been written in DB!\n","--------------------------------------------"
cur.close()

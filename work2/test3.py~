#!/usr/bin/python
#encoding=utf-8

import sys
import os
import socket
import MySQLdb
from threading import Thread
import re
import socket
from testttrace import gettrace

socket.setdefaulttimeout(150)

url=re.compile(r'^http://')

def main():
    con=MySQLdb.connect(host='localhost',user='root',passwd='19941017')
    cur=con.cursor()
    con.select_db('practice')
    count1=cur.execute("select id,asn,link from AStable ")
    aslist=cur.fetchall()
    #cur.execute("drop table if exists Ttable")
    #cur.execute("create table if not exists Ttable(id int,tid int,time varchar(50),primary key(id,tid))")   

    tmpip=socket.getaddrinfo("www.baidu.com", None)
    tgtip=tmpip[0][4][0]                         #get the ip of the target
    tgtip="202.118.236.190"
    for i in range(0,count1,20):                
    	threads=[]
        for j in range(20):
            pos=i+j
            if pos>=count1:
                break
            p=gettrace(aslist[i+j][0],aslist[i+j][1],aslist[i+j][2],tgtip)
            thread=Thread(target=p)
            threads.append(thread)
        length=len(threads)    
        for a in range(length):
	    print "\n","from as",aslist[i+a][2],"to","HIT","\n----------------------------"
            threads[a].start()
        for a in range(length):
            threads[a].join()
        
if __name__=='__main__':
    main()
         
        

#!/usr/bin/python
#encoding=utf-8

import sys
import socket
import MySQLdb
from gettracetmp import gettrace
from threading import Thread
import re
socket.setdefaulttimeout(600)

def main():
    print "please choose a way to traceroute!\n----------------------"
    print "usage 1:gettrace.py asn [iplist]\nusage 2:gettrace.py [asn] ip\n"
    m=input("input the usage number:")
    print "\n"
    
    if m==1: #method 1#############################################
        asn=input("input the as number:")
        print "\n"
        
        con=MySQLdb.connect(host='localhost',user='root',passwd='19941017')
        cur=con.cursor()
        con.select_db('practice')
        count=cur.execute("select link from AStable where asn=%d and avail='y'"%asn)
        asn=repr(asn)
        if count==0:
            print "this as is not available!\n"
            sys.exit(1)
            
        list=input("input the list of ip:")
        print "\n"
            
        urllist=cur.fetchall()
        urllen=len(urllist)
        for i in range(urllen):
            url=(urllist[i])[0] 
            length=len(list)
            threads=[]
            for i in range(length):
                p=gettrace(asn,url,list[i])
                thread=Thread(target=p)
                threads.append(thread)

            for i in range(length):
                threads[i].start()
            for i in range(length):
                threads[i].join()

            f=open("okurl.txt","r")
            fstr=f.read()
            f.close()
            if url in fstr:
                break
 #####################################################################

    

    if m==2:
        ip=raw_input("input the ip:")
        print "\n"
        list=input("input the list of as:")
        print "\n"
        hashurls={}
        hashptr={}
        okaslist=[]
        f=open("okas.txt","w")
        f.close()
        
        for asn in list:
            con=MySQLdb.connect(host='localhost',user='root',passwd='19941017')
            cur=con.cursor()
            con.select_db('practice')
            count=cur.execute("select link from AStable where asn=%d and avail='y'"%asn)
            if count==0:
                print "as ",asn," is not available!\n"
            else:
                okaslist.append(asn)
                urllist=cur.fetchall()
                hashurls[asn]=urllist
                hashptr[asn]=-1
                
        while True:
            threads=[]
            for asn in okaslist:
                hashptr[asn]+=1
                if hashptr[asn]==len(hashurls[asn]):
                    okaslist.remove(asn)
                    continue
                url=(hashurls[asn])[hashptr[asn]]
		print asn,url,ip
                p=gettrace(asn,url,ip)
                thread=Thread(target=p)
                threads.append(thread)
            for i in range(len(threads)):
                threads[i].start()
            for i in range(len(threads)):
                threads[i].join()
            
            f=open("okas.txt","r")
            fstr=f.read()
            f.close()
            for asn in okaslist:
                if repr(asn) in fstr:
                    okaslist.remove(asn)
            if okaslist==[]:
                break
        
        
if __name__=='__main__':
    main()
         
        
        
        
